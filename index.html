<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estratificador de Pacientes ECICEP</title>
  <meta name="description" content="Estratificador ECICEP (52 condiciones oficiales) — CESFAM Dr. Carlos Díaz Gidi 2025"/>
  <style>
    :root{
      --primary:#0b5ed7; --secondary:#f6f7fb; --border:#e5e7eb; --text:#1f2937; --bg:#fff;
      --g0:#28a745; --g1:#17a2b8; --g2:#ffc107; --g3:#dc3545; --shadow:0 6px 16px rgba(0,0,0,.08);
      --hl:#fff3cd; --hl-border:#ffe69c;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:var(--secondary);color:var(--text);margin:0;padding:24px}
    .container{max-width:1200px;margin:0 auto;background:var(--bg);border-radius:14px;box-shadow:var(--shadow);
      padding:24px;border:1px solid var(--border)}
    header h1{margin:0 0 6px;color:var(--primary);text-align:center}
    header p{margin:0 0 14px;text-align:center;color:#374151}
    .main{display:grid;grid-template-columns:1fr 340px;gap:24px}
    @media (max-width:980px){.main{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}

    details{border:1px solid var(--border);border-radius:10px;background:#fafafa;margin-top:12px}
    summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:700;color:#fff;background:var(--primary);
      border-radius:10px;display:flex;align-items:center;justify-content:space-between}
    details[open] summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
    .level-wrap{padding:10px 12px;background:#fff;border-top:1px solid var(--border);border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    .sub-details{border:1px solid #dbeafe;border-radius:8px;background:#eef2ff;margin:10px 0}
    .sub-summary{background:#eef2ff;color:#1e40af;border-radius:8px;padding:8px 12px;font-weight:700;
      display:flex;align-items:center;justify-content:space-between}
    .sub-content{padding:8px 10px;background:#fff;border-top:1px solid #dbeafe}

    .row{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;padding:8px 0;border-bottom:1px dashed #eceff3}
    .row:last-child{border-bottom:none}
    .row input[type=checkbox]{width:18px;height:18px}
    .row label{font-weight:600}
    .row.match{background:var(--hl);border:1px solid var(--hl-border);border-radius:8px;padding:8px;margin:4px 0}
    .badge{font-size:.75rem;font-weight:700;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff}

    .topbar{display:flex;gap:8px;align-items:center;margin:6px 0 14px}
    .search{flex:1;display:flex;gap:8px; position:relative;}
    .search input{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:1rem}
    .search button{padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:#f3f4f6;cursor:pointer}

    .cie{margin:8px 0 16px 26px;border:1px dashed #e5e7eb;border-radius:8px;background:#f9fafb}
    .cie summary{background:#f3f4f6;color:#111827;border-radius:8px;padding:6px 10px}
    .cie .inner{padding:10px}
    .cie-table{width:100%;border-collapse:collapse;font-size:.92rem}
    .cie-table th,.cie-table td{border:1px solid #e5e7eb;padding:6px 8px;text-align:left}
    .cie-table th{background:#eef2ff;color:#1e3a8a}
    .cie-help{font-size:.82rem;color:#6b7280;margin-top:4px}

    .results h3{margin:0 0 10px;color:#0b5ed7;text-align:center;border-bottom:2px solid var(--border);padding-bottom:10px}
    #score{font-size:3.2em;text-align:center;font-weight:900;margin:10px 0;color:#111827}
    #glevel{text-align:center;font-weight:900;font-size:2em;margin-bottom:10px;color:#fff;border-radius:8px;padding:6px}
    #gdesc{font-size:.95em;padding:10px;background:#f8fafc;border-radius:8px;border-left:6px solid}
    .g0{background-color:var(--g0);border-color:var(--g0)} .g1{background-color:var(--g1);border-color:var(--g1)}
    .g2{background-color:var(--g2);border-color:var(--g2);color:#111827} .g3{background-color:var(--g3);border-color:var(--g3)}
    .btn{width:100%;padding:12px;font-size:1.05em;font-weight:800;border:none;border-radius:10px;cursor:pointer;background:#374151;color:#fff;margin-top:10px}
    footer{margin-top:18px;font-size:.9rem;color:#4b5563;text-align:center}

    /* === AUTOCOMPLETE === */
    .autocomplete-box{
      position:absolute; top:100%; left:0; right:0; margin-top:6px;
      background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow);
      max-height:260px; overflow-y:auto; z-index:2000;
    }
    .ac-item{padding:10px 12px; cursor:pointer; display:flex; gap:8px; align-items:flex-start}
    .ac-item:hover, .ac-item.active{background:#eef2ff}
    .ac-code{font-weight:800; min-width:54px}
    .ac-desc{flex:1}
    .ac-empty{padding:10px 12px; color:#6b7280}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Estratificador de Pacientes ECICEP</h1>
    <p>Basado en el Anexo oficial (52 condiciones). CIE-10 tabular aplicado.</p>
    <details class="card" open>
      <summary class="sub-summary">Cómo usarlo</summary>
      <div class="sub-content">
        <ol>
          <li>Abra los bloques de <strong>2 puntos</strong> y <strong>1 punto</strong> y marque las condiciones que correspondan.</li>
          <li>El buscador es <strong>complementario</strong>: despliega solapas y <em>resalta</em> coincidencias por nombre o código CIE-10.</li>
          <li>En cada ítem puede ver el detalle de <strong>CIE-10</strong> (código + diagnóstico) desplegando la sección.</li>
          <li>La tarjeta derecha muestra el <strong>puntaje total</strong> y el <strong>nivel G0–G3</strong> automáticamente.</li>
          <li>Use <strong>“Limpiar selección”</strong> para reiniciar todo.</li>
        </ol>
      </div>
    </details>
  </header>
  <div class="main">
    <div>
      <div class="card">
        <div class="topbar">
          <div class="search" style="width:100%">
            <input id="q" type="search" placeholder="Buscar patología o código CIE-10…" aria-label="Buscar patología" />
            <button id="clearQ" title="Limpiar búsqueda">Limpiar</button>
            <div id="suggestions" class="autocomplete-box" role="listbox" hidden></div>
          </div>
        </div>
        <h2 style="margin:6px 0 12px">Condiciones crónicas</h2>
        <div id="list"></div>
      </div>
    </div>
    <aside>
      <div class="card results">
        <h3>Resultado de Estratificación</h3>
        <div id="score">0</div>
        <div id="glevel" class="g0">G0</div>
        <p id="gdesc" class="g0"><strong>Bajo Riesgo:</strong> Sin patologías con puntaje.</p>
        <button class="btn" onclick="resetForm()">Limpiar selección</button>
      </div>
      <footer>
        Creado por <strong>Diego Ortega Araya</strong> – <strong>CESFAM Dr. Carlos Díaz Gidi</strong>.
      </footer>
    </aside>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function el(tag, props={}, children=[]){
  const n=document.createElement(tag);
  Object.entries(props).forEach(([k,v])=>{
    if(k==='class') n.className=v;
    else if(k==='text') n.textContent=v;
    else if(k==='html') n.innerHTML=v;
    else n[k]=v;
  });
  children.forEach(c=>n.appendChild(c));
  return n;
}
function normalize(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

/* ===== CIE-10 — Diccionario (todas las familias/códigos usados) ===== */
const CIE = {
  // ===== GRUPO 2 PUNTOS =====
  // Demencia
  "F00":"Demencia en la enfermedad de Alzheimer",
  "F00.0":"Demencia en la enfermedad de Alzheimer de inicio temprano",
  "F00.1":"Demencia en la enfermedad de Alzheimer de inicio tardío",
  "F00.2":"Demencia en la enfermedad de Alzheimer, forma atípica o mixta",
  "F00.9":"Demencia en la enfermedad de Alzheimer, no especificada",
  "F01":"Demencia vascular",
  "F01.0":"Demencia vascular de inicio agudo",
  "F01.1":"Demencia multiinfarto",
  "F01.2":"Demencia vascular subcortical",
  "F01.3":"Demencia vascular mixta (cortical y subcortical)",
  "F01.8":"Otras demencias vasculares",
  "F01.9":"Demencia vascular, no especificada",
  "F02":"Demencia en otras enfermedades",
  "F02.0":"Demencia en la enfermedad de Pick",
  "F02.1":"Demencia en la enfermedad de Creutzfeldt-Jakob",
  "F02.2":"Demencia en la enfermedad de Huntington",
  "F02.3":"Demencia en la enfermedad de Parkinson",
  "F02.4":"Demencia en la infección por VIH",
  "F02.8":"Demencia en otras enfermedades especificadas",
  "F03":"Demencia, no especificada",

  // Depresión grave
  "F33":"Trastorno depresivo recurrente",
  "F33.0":"Trastorno depresivo recurrente, episodio actual leve",
  "F33.1":"Trastorno depresivo recurrente, episodio actual moderado",
  "F33.2":"Trastorno depresivo recurrente, episodio actual grave sin síntomas psicóticos",
  "F33.3":"Trastorno depresivo recurrente, episodio actual grave con síntomas psicóticos",
  "F33.4":"Trastorno depresivo recurrente, en remisión",
  "F33.8":"Otros trastornos depresivos recurrentes",
  "F33.9":"Trastorno depresivo recurrente, no especificado",

  // Esquizofrenia y psicosis
  "F20":"Esquizofrenia",
  "F20.0":"Esquizofrenia paranoide",
  "F20.1":"Esquizofrenia hebefrénica (desorganizada)",
  "F20.2":"Esquizofrenia catatónica",
  "F20.3":"Esquizofrenia indiferenciada",
  "F20.4":"Depresión postesquizofrénica",
  "F20.5":"Esquizofrenia residual",
  "F20.6":"Esquizofrenia simple",
  "F20.8":"Otras esquizofrenias",
  "F20.9":"Esquizofrenia, no especificada",
  "F21":"Trastorno esquizotípico",
  "F22":"Trastornos de ideas delirantes persistentes",
  "F22.0":"Trastorno delirante (paranoide)",
  "F22.8":"Otros trastornos delirantes persistentes",
  "F22.9":"Trastorno delirante persistente, no especificado",
  "F23":"Trastornos psicóticos agudos y transitorios",
  "F23.0":"Trastorno psicótico agudo polimorfo sin síntomas de esquizofrenia",
  "F23.1":"Trastorno psicótico agudo polimorfo con síntomas de esquizofrenia",
  "F23.2":"Trastorno psicótico agudo de tipo esquizofrénico",
  "F23.3":"Otros trastornos psicóticos agudos predominantemente delirantes",
  "F23.8":"Otros trastornos psicóticos agudos y transitorios",
  "F23.9":"Trastorno psicótico agudo y transitorio, no especificado",

  // ECV / ACV
  "G46":"Síndromes vasculares cerebrales",
  "G46.0":"Síndrome vascular cerebral de la arteria cerebral media",
  "G46.1":"Síndrome vascular cerebral de la arteria cerebral anterior",
  "G46.2":"Síndrome vascular cerebral de la arteria cerebral posterior",
  "G46.3":"Síndrome vascular del tallo cerebral",
  "G46.4":"Síndrome vascular cerebeloso",
  "G46.5":"Síndrome lacunar cerebral",
  "G46.6":"Síndromes vasculares múltiples y bilaterales",
  "G46.7":"Síndrome vascular cerebral no especificado del encéfalo",
  "G46.8":"Otros síndromes vasculares cerebrales especificados",
  "I64":"Accidente vascular cerebral, no especificado",
  "I67":"Otras enfermedades cerebrovasculares",
  "I67.0":"Estenosis y oclusión de arterias precerebrales sin infarto cerebral",
  "I67.1":"Aneurisma cerebral roto",
  "I67.2":"Aterosclerosis cerebral",
  "I67.3":"Leucoencefalopatía vascular progresiva",
  "I67.4":"Encefalopatía hipertensiva",
  "I67.5":"Oclusión y estenosis de arterias cerebrales sin infarto",
  "I67.7":"Encefalitis arterítica",
  "I67.8":"Otras enfermedades cerebrovasculares especificadas",
  "I67.9":"Enfermedad cerebrovascular, no especificada",
  "I68":"Trastornos cerebrovasculares en otras enfermedades",
  "I68.0":"Trastornos cerebrovasculares en enfermedades infecciosas y parasitarias",
  "I68.1":"Trastornos cerebrovasculares en enfermedades vasculares sistémicas",
  "I68.2":"Trastornos cerebrovasculares en otras enfermedades especificadas",
  "I68.8":"Trastornos cerebrovasculares en otras enfermedades, no especificados",

  // Cardiopatía isquémica (IAM/angina/enf. crónica)
  "I20":"Angina de pecho",
  "I20.0":"Angina inestable",
  "I20.1":"Angina vasoespástica (Prinzmetal)",
  "I20.8":"Otras formas de angina de pecho",
  "I20.9":"Angina de pecho, no especificada",
  "I21":"Infarto agudo de miocardio",
  "I21.0":"IAM transmural de la pared anterior",
  "I21.1":"IAM transmural de la pared inferior",
  "I21.2":"IAM transmural de otras localizaciones",
  "I21.3":"IAM transmural, localización no especificada",
  "I21.4":"IAM subendocárdico (no Q)",
  "I21.9":"IAM, no especificado",
  "I22":"Infarto de miocardio subsecuente",
  "I22.0":"Infarto subsecuente de la pared anterior",
  "I22.1":"Infarto subsecuente de la pared inferior",
  "I22.8":"Infarto subsecuente de otras localizaciones",
  "I22.9":"Infarto subsecuente, no especificado",
  "I25":"Enfermedad isquémica crónica del corazón",
  "I25.0":"Enfermedad isquémica crónica del corazón",
  "I25.1":"Enfermedad isquémica crónica del corazón",
  "I25.2":"Infarto antiguo de miocardio",
  "I25.3":"Aneurisma del corazón",
  "I25.4":"Aneurisma de arteria coronaria",
  "I25.5":"Isquemia crónica del miocardio",
  "I25.6":"Isquemia silenciosa",
  "I25.8":"Otras enfermedades isquémicas crónicas del corazón",
  "I25.9":"Enfermedad isquémica crónica del corazón, no especificada",

  // I51–I52 (subespecificados)
  "I51":"Complicaciones y descripciones mal definidas de enfermedad del corazón",
  "I51.0":"Defectos cardíacos adquiridos y otras complicaciones",
  "I51.4":"Miocarditis aguda, no especificada",
  "I51.5":"Miocarditis, no especificada",
  "I51.6":"Insuficiencia cardíaca no especificada",
  "I51.7":"Cardiomegalia",
  "I51.8":"Otros trastornos cardíacos especificados",
  "I51.9":"Trastorno cardíaco, no especificado",
  "I52":"Otros trastornos del corazón en enfermedades clasificadas en otra parte",
  "I52.0":"Trastornos cardíacos en enfermedades infecciosas y parasitarias",
  "I52.1":"Trastornos cardíacos en otras enfermedades clasificadas en otra parte",
  "I52.8":"Otros trastornos del corazón en enfermedades clasificadas en otra parte",

  // Diabetes (todas las familias, con especificadores .0–.9)
  "E10":"Diabetes mellitus insulinodependiente (tipo 1)",
  "E11":"Diabetes mellitus no insulinodependiente (tipo 2)",
  "E12":"Diabetes mellitus relacionada con malnutrición",
  "E13":"Otras diabetes mellitus especificadas",
  "E14":"Diabetes mellitus, no especificada",
  "E10.0":"Diabetes mellitus tipo 1 con coma",
  "E10.1":"Diabetes mellitus tipo 1 con cetoacidosis",
  "E10.2":"Diabetes mellitus tipo 1 con complicaciones renales",
  "E10.3":"Diabetes mellitus tipo 1 con complicaciones oftálmicas",
  "E10.4":"Diabetes mellitus tipo 1 con complicaciones neurológicas",
  "E10.5":"Diabetes mellitus tipo 1 con complicaciones circulatorias periféricas",
  "E10.6":"Diabetes mellitus tipo 1 con otras complicaciones especificadas",
  "E10.7":"Diabetes mellitus tipo 1 con complicaciones múltiples",
  "E10.8":"Diabetes mellitus tipo 1 con complicaciones no especificadas",
  "E10.9":"Diabetes mellitus tipo 1, sin complicaciones",
  "E11.0":"Diabetes mellitus tipo 2 con coma",
  "E11.1":"Diabetes mellitus tipo 2 con cetoacidosis",
  "E11.2":"Diabetes mellitus tipo 2 con complicaciones renales",
  "E11.3":"Diabetes mellitus tipo 2 con complicaciones oftálmicas",
  "E11.4":"Diabetes mellitus tipo 2 con complicaciones neurológicas",
  "E11.5":"Diabetes mellitus tipo 2 con complicaciones circulatorias periféricas",
  "E11.6":"Diabetes mellitus tipo 2 con otras complicaciones especificadas",
  "E11.7":"Diabetes mellitus tipo 2 con complicaciones múltiples",
  "E11.8":"Diabetes mellitus tipo 2 con complicaciones no especificadas",
  "E11.9":"Diabetes mellitus tipo 2, sin complicaciones",
  "E12.0":"Diabetes por malnutrición con coma",
  "E12.1":"Diabetes por malnutrición con cetoacidosis",
  "E12.2":"Diabetes por malnutrición con complicaciones renales",
  "E12.3":"Diabetes por malnutrición con complicaciones oftálmicas",
  "E12.4":"Diabetes por malnutrición con complicaciones neurológicas",
  "E12.5":"Diabetes por malnutrición con complicaciones circulatorias periféricas",
  "E12.6":"Diabetes por malnutrición con otras complicaciones especificadas",
  "E12.7":"Diabetes por malnutrición con complicaciones múltiples",
  "E12.8":"Diabetes por malnutrición con complicaciones no especificadas",
  "E12.9":"Diabetes por malnutrición, sin complicaciones",
  "E13.0":"Otras diabetes especificadas con coma",
  "E13.1":"Otras diabetes especificadas con cetoacidosis",
  "E13.2":"Otras diabetes especificadas con complicaciones renales",
  "E13.3":"Otras diabetes especificadas con complicaciones oftálmicas",
  "E13.4":"Otras diabetes especificadas con complicaciones neurológicas",
  "E13.5":"Otras diabetes especificadas con complicaciones circulatorias periféricas",
  "E13.6":"Otras diabetes especificadas con otras complicaciones",
  "E13.7":"Otras diabetes especificadas con complicaciones múltiples",
  "E13.8":"Otras diabetes especificadas con complicaciones no especificadas",
  "E13.9":"Otras diabetes especificadas, sin complicaciones",
  "E14.0":"Diabetes no especificada con coma",
  "E14.1":"Diabetes no especificada con cetoacidosis",
  "E14.2":"Diabetes no especificada con complicaciones renales",
  "E14.3":"Diabetes no especificada con complicaciones oftálmicas",
  "E14.4":"Diabetes no especificada con complicaciones neurológicas",
  "E14.5":"Diabetes no especificada con complicaciones circulatorias periféricas",
  "E14.6":"Diabetes no especificada con otras complicaciones",
  "E14.7":"Diabetes no especificada con complicaciones múltiples",
  "E14.8":"Diabetes no especificada con complicaciones no especificadas",
  "E14.9":"Diabetes no especificada, sin complicaciones",

  // ERC avanzada
  "N18":"Enfermedad renal crónica",
  "N18.1":"Enfermedad renal crónica, estadio 1",
  "N18.2":"Enfermedad renal crónica, estadio 2",
  "N18.3":"Enfermedad renal crónica, estadio 3",
  "N18.4":"Enfermedad renal crónica, estadio 4",
  "N18.5":"Enfermedad renal crónica, estadio 5",
  "N18.6":"Enfermedad renal en etapa terminal",
  "N18.9":"Enfermedad renal crónica, no especificada",

  // Funcionalidad / Dependencia
  "R26":"Anomalías de la marcha y de la movilidad",
  "R26.0":"Ataxia de la marcha",
  "R26.1":"Dificultad para la marcha",
  "R26.2":"Trastorno de la marcha, no especificado",
  "R26.8":"Otras anomalías de la marcha y de la movilidad",
  "Z74":"Problemas relacionados con dependencia del prestador de cuidados",
  "Z74.0":"Dependencia completa de cuidados",
  "Z74.1":"Dependencia parcial de cuidados",
  "Z74.2":"Necesidad de asistencia permanente",
  "Z74.3":"Supervisión y vigilancia domiciliaria",
  "Z74.8":"Otros problemas relacionados con cuidados",
  "Z74.9":"Problema relacionado con cuidados, no especificado",
  "Z99":"Dependencia de máquinas y dispositivos de apoyo",
  "Z99.0":"Dependencia de respirador",
  "Z99.1":"Dependencia de oxígeno",
  "Z99.2":"Dependencia de diálisis",
  "Z99.3":"Dependencia de silla de ruedas",
  "Z99.8":"Dependencia de otras máquinas y dispositivos especificados",
  "Z99.9":"Dependencia de máquina o dispositivo, no especificada",

  // ===== GRUPO 1 PUNTO =====
  // Alcohol
  "F10":"Trastornos mentales y del comportamiento por uso de alcohol",
  "F10.0":"Intoxicación aguda por alcohol",
  "F10.1":"Uso nocivo de alcohol",
  "F10.2":"Síndrome de dependencia de alcohol",
  "F10.3":"Síndrome de abstinencia de alcohol",
  "F10.4":"Síndrome de abstinencia de alcohol con delirium",
  "F10.5":"Trastorno psicótico por alcohol",
  "F10.6":"Síndrome amnésico por alcohol",
  "F10.7":"Trastorno psicótico residual y de aparición tardía por alcohol",
  "F10.8":"Otros trastornos mentales y del comportamiento por alcohol",
  "F10.9":"Trastorno mental y del comportamiento por alcohol, no especificado",
  "Y91":"Evidencia de alcoholismo (impregnación alcohólica)",
  "Y91.2":"Evidencia de alcoholismo moderada",
  "Y91.3":"Evidencia de alcoholismo grave",
  "Y91.9":"Evidencia de alcoholismo, no especificada",
  "Z71.4":"Consulta por abuso de alcohol",
  "Z72.1":"Problemas relacionados con consumo de alcohol",

  // Tabaco
  "F17":"Trastornos mentales y del comportamiento por uso de tabaco",
  "F17.0":"Intoxicación aguda por tabaco",
  "F17.1":"Uso nocivo de tabaco",
  "F17.2":"Síndrome de dependencia de tabaco",
  "F17.3":"Síndrome de abstinencia de tabaco",
  "F17.4":"Síndrome de abstinencia de tabaco con delirium",
  "F17.5":"Trastorno psicótico por tabaco",
  "F17.6":"Síndrome amnésico por tabaco",
  "F17.7":"Trastorno psicótico residual y de aparición tardía por tabaco",
  "F17.8":"Otros trastornos mentales y del comportamiento por tabaco",
  "F17.9":"Trastorno mental y del comportamiento por tabaco, no especificado",
  "T65.2":"Efecto tóxico del tabaco y la nicotina",
  "Z71.6":"Consejo por tabaquismo",
  "Z72.0":"Problemas relacionados con uso de tabaco",

  // Drogas (familias F11–F16, F18, F19 con .0–.9)
  "F11":"Trastornos por uso de opiáceos",
  "F12":"Trastornos por uso de cannabinoides",
  "F13":"Trastornos por uso de sedantes o hipnóticos",
  "F14":"Trastornos por uso de cocaína",
  "F15":"Trastornos por uso de otros estimulantes (incluida cafeína)",
  "F16":"Trastornos por uso de alucinógenos",
  "F18":"Trastornos por uso de disolventes volátiles",
  "F19":"Trastornos por uso de múltiples drogas y otras sustancias",

  // Anemias (familias usadas) — (recortada aquí por espacio: sigue en las tablas de cada ítem)
  "D50":"Anemia por deficiencia de hierro",
  "D51.0":"Anemia por deficiencia de vitamina B12 debida a dieta",
  "D51.1":"Anemia por deficiencia de vitamina B12 debida a malabsorción selectiva",
  "D51.2":"Anemia por deficiencia de vitamina B12 por otros trastornos",
  "D51.8":"Otras anemias por deficiencia de vitamina B12",
  "D51.9":"Anemia por deficiencia de vitamina B12, no especificada",
  "D52.0":"Anemia por deficiencia de folato debida a dieta",
  "D52.1":"Anemia por deficiencia de folato debida a malabsorción",
  "D52.8":"Otras anemias por deficiencia de folato",
  "D52.9":"Anemia por deficiencia de folato, no especificada",
  "D53.0":"Anemia por proteínas deficientes",
  "D53.1":"Otras anemias megaloblásticas, no clasificadas en otra parte",
  "D53.2":"Anemia por otras deficiencias nutricionales",
  "D53.8":"Otras anemias nutricionales especificadas",
  "D53.9":"Anemia nutricional, no especificada",

  // (… el objeto CIE continúa como en tu versión, sin cambios …)
  "M79.7":"Fibromialgia",
  "K50":"Enfermedad de Crohn",
  "K51":"Colitis ulcerosa",
  "K52":"Otras colitis y gastroenteritis no infecciosas",
  "B18":"Hepatitis viral crónica",
  "K70":"Enfermedad hepática alcohólica",
  "K71":"Enfermedad hepática tóxica",
  "K72":"Insuficiencia hepática",
  "K73":"Hepatitis crónica",
  "K74":"Fibrosis y cirrosis del hígado",
  "K76.6":"Hipertensión portal",
  "B21":"Enfermedad por VIH con tumores malignos",
  "B22":"Enfermedad por VIH con otras enfermedades",
  "B23":"Enfermedad por VIH con otras afecciones",
  "B24":"Enfermedad por VIH, no especificada",
  "A15":"Tuberculosis respiratoria, confirmada",
  "A16":"Tuberculosis respiratoria, no confirmada",
  "A17":"Tuberculosis del sistema nervioso",
  "A18":"Tuberculosis de otros órganos",
  "A19":"Tuberculosis miliar",
  "D68":"Otros defectos de la coagulación",
  "D69.1":"Púrpura no trombocitopénica",
  "D69.2":"Otras púrpuras no trombocitopénicas",
  "D69.4":"Púrpura y otras hemorragias debidas a trastornos plaquetarios",
  "D69.6":"Trombocitopenia primaria",
  "D69.8":"Otros trastornos hemorrágicos especificados",
  "D69.9":"Trastorno hemorrágico, no especificado",
  "D75.0":"Eritrocitosis primaria",
  "D75.8":"Otros trastornos especificados de la sangre",
  "D75.9":"Trastorno de la sangre, no especificado",
  "D77":"Otros trastornos de la sangre en otras enfermedades",
  "E01":"Trastornos tiroideos por deficiencia de yodo",
  "E02":"Hipotiroidismo subclínico por deficiencia de yodo",
  "E03":"Otros hipotiroidismos",
  "E05":"Tirotoxicosis (hipertiroidismo)",
  "E66":"Obesidad",
  "N15":"Otras enfermedades renales tubulointersticiales",
  "N19":"Insuficiencia renal, no especificada",
  "N40":"Hiperplasia de la próstata",
  "F40":"Trastornos de ansiedad fóbica",
  "F41":"Otros trastornos de ansiedad",
  "F60":"Trastornos específicos de la personalidad",
  "F61":"Trastornos mixtos y otros de la personalidad",
  "F62.0":"Cambios perdurables de la personalidad tras experiencia catastrófica",
  "F62.1":"Cambios perdurables de la personalidad tras enfermedad psiquiátrica",
  "F62.8":"Otros cambios perdurables de la personalidad",
  "F62.9":"Cambio perdurable de la personalidad, no especificado",
  "F68.0":"Elaboración de síntomas físicos por razones psicológicas",
  "F69":"Trastorno de la personalidad y del comportamiento del adulto, no especificado",
  "F51":"Trastornos no orgánicos del sueño",
  "G47":"Trastornos del sueño",
  "F31":"Trastorno afectivo bipolar",
  "F34":"Trastornos del humor (afectivos) persistentes",
  "F63":"Trastornos de los hábitos y de los impulsos",
  "F66.1":"Trastorno del desarrollo psicosexual",
  "F66.2":"Trastornos de la identidad sexual",
  "F66.8":"Otros trastornos del desarrollo psicosexual",
  "F66.9":"Trastorno del desarrollo psicosexual, no especificado",
  "L93":"Lupus eritematoso",
  "M32":"Lupus eritematoso sistémico",
  "M10":"Gota",
  "T74":"Síndromes del maltrato",
  "Y07":"Autor del maltrato y abandono",
  "H25":"Catarata senil",
  "H26":"Otras cataratas",
  "H28":"Catarata y otros trastornos del cristalino en otras enfermedades",
  "Q12":"Malformaciones congénitas del cristalino",
  "H54":"Ceguera y baja visión",
  "H40":"Glaucoma",
  "H42":"Glaucoma en otras enfermedades",
  "H90":"Hipoacusia conductiva y neurosensorial",
  "H91":"Otras hipoacusias",
  "E78":"Trastornos del metabolismo de las lipoproteínas",
  "I10":"Hipertensión esencial (primaria)",
  "I11.0":"Enfermedad cardíaca hipertensiva con insuficiencia cardíaca",
  "I11.9":"Enfermedad cardíaca hipertensiva sin insuficiencia cardíaca",
  "I12.0":"Enfermedad renal hipertensiva con insuficiencia renal",
  "I12.9":"Enfermedad renal hipertensiva sin insuficiencia renal",
  "I13.0":"Enfermedad cardiorrenal hipertensiva con insuficiencia cardíaca",
  "I13.1":"Enfermedad cardiorrenal hipertensiva con insuficiencia renal",
  "I13.2":"Enfermedad cardiorrenal hipertensiva con insuficiencia cardíaca y renal",
  "I13.9":"Enfermedad cardiorrenal hipertensiva, no especificada",
  "I48":"Fibrilación y aleteo auricular",
  "I47":"Taquicardia paroxística",
  "I49.0":"Fibrilación y aleteo ventricular",
  "I49.8":"Otras arritmias cardíacas especificadas",
  "I49.9":"Arritmia cardíaca, no especificada",
  "I50":"Insuficiencia cardíaca",
  "I83":"Várices de miembros inferiores",
  "L97":"Úlcera de miembro inferior, no clasificada en otra parte",
  "L98.4":"Úlcera crónica de la piel, no clasificada en otra parte",
  "G45":"Ataques isquémicos cerebrales transitorios",
  "G40":"Epilepsia",
  "G35":"Esclerosis múltiple",
  "G20":"Enfermedad de Parkinson",
  "G21.1":"Parkinsonismo secundario a otros agentes",
  "G22":"Parkinsonismo en otras enfermedades",
  "G23.0":"Degeneración estriato-nigral",
  "G23.1":"Atrofia multisistémica",
  "G23.2":"Degeneración de los ganglios basales",
  "G23.8":"Otras enfermedades degenerativas de los ganglios basales",
  "G23.9":"Enfermedad degenerativa de los ganglios basales, no especificada",
  "G24":"Distonía",
  "G25.2":"Hemibalismo",
  "G25.3":"Mioclono",
  "G25.4":"Corea",
  "G25.5":"Temblores",
  "G26":"Trastornos extrapiramidales en otras enfermedades",
  "G50":"Trastornos del nervio trigémino",
  // (… resto sin cambios …)
};
/* ===== Estructura (52 condiciones exactas) ===== */
function exp(base, digits){ return (digits||[]).map(d=>`${base}.${d}`); }
function expMany(specs){
  const out=[];
  (specs||[]).forEach(s=>{
    if(typeof s==="string") out.push(s);
    else if(s && s.base && Array.isArray(s.subs)) out.push(...exp(s.base,s.subs));
  });
  return out;
}

const GROUPS = [
  {points:2, title:'Condiciones que suman 2 puntos (8)', subgroups:[
    {name:'Neuro-psiquiatría', items:[
      {id:'demencia',    name:'Demencia', codes:['F00.0','F00.1','F00.2','F00.9','F01.0','F01.1','F01.2','F01.3','F01.8','F01.9','F02.0','F02.1','F02.2','F02.3','F02.4','F02.8','F03']},
      {id:'dep_grave',   name:'Depresión (Grave, con ideación suicida, refractaria y/o con psicosis)', codes:['F33.2','F33.3']},
      {id:'esquizo',     name:'Esquizofrenia y otros trastornos psicóticos', codes:['F20.0','F20.1','F20.2','F20.3','F20.4','F20.5','F20.6','F20.8','F20.9','F21','F22.0','F22.8','F22.9','F23.0','F23.1','F23.2','F23.3','F23.8','F23.9']}
    ]},
    {name:'Eventos cardio-cerebro-renales', items:[
      {id:'ecv',   name:'Enfermedad cerebrovascular / ACV / AVE', codes:['G46.0','G46.1','G46.2','G46.3','G46.4','G46.5','G46.6','G46.7','G46.8','I64','I67.0','I67.1','I67.2','I67.3','I67.4','I67.5','I67.7','I67.8','I67.9','I68.0','I68.1','I68.2','I68.8']},
      {id:'isci',  name:'Enfermedades cardiovasculares / IAM / cardiopatía isquémica', codes:['I20.0','I20.1','I20.8','I20.9','I21.0','I21.1','I21.2','I21.3','I21.4','I21.9','I22.0','I22.1','I22.8','I22.9','I25.0','I25.1','I25.2','I25.3','I25.4','I25.5','I25.6','I25.8','I25.9','I51.0','I51.4','I51.5','I51.6','I51.7','I51.8','I51.9','I52.0','I52.1','I52.8']},
      {id:'dm',    name:'Diabetes mellitus', codes:[...expMany([{base:'E10',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expMany([{base:'E11',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expMany([{base:'E12',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expMany([{base:'E13',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expMany([{base:'E14',subs:[0,1,2,3,4,5,6,7,8,9]}])]},
      {id:'erc_av', name:'Enfermedad renal crónica avanzada (IV-V)', codes:['N18.4','N18.5','N18.6']}
    ]},
    {name:'Funcionalidad', items:[
      {id:'dependencia', name:'Función limitada / discapacidad / dependencia', codes:['R26.0','R26.1','R26.2','R26.8','Z74.0','Z74.1','Z74.2','Z74.3','Z74.8','Z74.9','Z99.0','Z99.1','Z99.2','Z99.3','Z99.8','Z99.9']}
    ]}
  ]},
  {points:1, title:'Condiciones que suman 1 punto (44)', subgroups:[
    {name:'Salud Mental y Conductual', items:[
      {id:'alcohol',     name:'Consumo perjudicial o dependiente de alcohol', codes:['F10.0','F10.1','F10.2','F10.3','F10.4','F10.5','F10.6','F10.7','F10.8','F10.9','Y91.2','Y91.3','Y91.9','Z71.4','Z72.1']},
      {id:'tabaquismo',  name:'Tabaquismo', codes:['F17.0','F17.1','F17.2','F17.3','F17.4','F17.5','F17.6','F17.7','F17.8','F17.9','T65.2','Z71.6','Z72.0']},
      {id:'drogas',      name:'Consumo perjudicial o dependiente de drogas', codes:[...expMany([{base:'F11',subs:['0','1','2','3','4','5','6','7','8','9']}]),...expMany([{base:'F12',subs:['0','1','2','3','4','5','6','7','8','9']}]),...expMany([{base:'F13',subs:['0','1','2','3','4','5','6','7','8','9']}]),...expMany([{base:'F14',subs:['0','1','2','3','4','5','6','7','8','9']}]),...expMany([{base:'F15',subs:['0','1','2','3','4','5','6','7','8','9']}]),...expMany([{base:'F16',subs:['0','1','2','3','4','5','6','7','8','9']}]),...expMany([{base:'F18',subs:['0','1','2','3','4','5','6','7','8','9']}]),...expMany([{base:'F19',subs:['0','1','2','3','4','5','6','7','8','9']}]),'Z72.2']},
      {id:'tca',         name:'Trastornos alimentarios', codes:['F50.0','F50.1','F50.2','F50.3','F50.4','F50.5','F50.8','F50.9']},
      {id:'dep_leve',    name:'Depresión Leve o moderada', codes:['F33.0','F33.1','F33.4','F33.8','F33.9']},
      {id:'retraso_mental',name:'Retraso mental', codes:['F70.0','F70.1','F70.8','F70.9','F71.0','F71.1','F71.8','F71.9','F72.0','F72.1','F72.8','F72.9','F73.0','F73.1','F73.8','F73.9','F78.0','F78.1','F78.8','F78.9','F79.0','F79.1','F79.8','F79.9']},
      {id:'ansiedad',    name:'Trastorno Ansioso', codes:['F40.0','F40.1','F40.2','F40.8','F40.9', 'F41.0','F41.1','F41.2','F41.3','F41.8','F41.9']},
      {id:'tp',          name:'Trastorno de la personalidad', codes:['F60.0','F60.1','F60.2','F60.3','F60.4','F60.5','F60.6','F60.7','F60.8','F60.9', 'F61', 'F62.0','F62.1','F62.8','F62.9', 'F68.0', 'F69']},
      {id:'tsueño',      name:'Trastornos del sueño', codes:['F51.0','F51.1','F51.2','F51.4','F51.9','F51.8', 'G47.3','G47.4','G47.8','G47.9']},
      {id:'otros_sm',    name:'Otros trastornos de Salud Mental', codes:['F31.0','F31.1','F31.2','F31.3','F31.4','F31.5','F31.6','F31.7','F31.8','F31.9', 'F34.0','F34.1','F34.8','F34.9', 'F63.0','F63.2','F63.8','F63.9', 'F66.1','F66.2','F66.8','F66.9']}
    ]},
    {name:'Cardiovascular y Vascular Periférico', items:[
      {id:'dislipidemia',name:'Dislipidemias', codes:['E78.0','E78.1','E78.2','E78.3','E78.4','E78.5','E78.6','E78.8','E78.9']},
      {id:'hta',         name:'Hipertensión', codes:['I10','I11.0','I11.9','I12.0','I12.9','I13.0','I13.1','I13.2','I13.9']},
      {id:'fa',          name:'Fibrilación auricular / flutter', codes:['I48.0','I48.1','I48.2','I48.3','I48.4','I48.9']},
      {id:'arritmias',   name:'Arritmia cardíaca / Taquicardia paroxística', codes:['I47.0','I47.1','I47.2','I47.9','I49.0','I49.8','I49.9']},
      {id:'insuf_card',  name:'Insuficiencia cardíaca', codes:['I50.0','I50.1','I50.9']},
      {id:'ulcera',      name:'Úlcera crónica de la piel', codes:['I83.0','I83.1','I83.2','I83.9','L97','L98.4']}
    ]},
    {name:'Neurológico', items:[
      {id:'tia',         name:'Isquemia cerebral transitoria (TIA)', codes:['G45.0','G45.1','G45.2','G45.3','G45.4','G45.8','G45.9']},
      {id:'epilepsia',   name:'Epilepsia', codes:['G40.0','G40.1','G40.2','G40.3','G40.4','G40.6','G40.7','G40.8','G40.9']},
      {id:'em',          name:'Esclerosis múltiple', codes:['G35']},
      {id:'parkinson',   name:'Parkinsonismo', codes:['G20','G21.1','G22','G23.0','G23.1','G23.2','G23.8','G23.9','G24.0','G24.1','G24.2','G24.4','G24.5','G24.8','G24.9','G25.2','G25.3','G25.4','G25.5','G26']}
    ]},
    {name:'Respiratorio', items:[
      {id:'asma', name:'Asma', codes:['J45.0','J45.1','J45.8','J45.9','J46']},
      {id:'epoc', name:'Enfermedad pulmonar obstructiva crónica (EPOC)', codes:['J41.0','J41.1','J41.8','J42','J43.0','J43.1','J43.2','J43.8','J43.9','J44.0','J44.1','J44.8','J44.9']}
    ]},
    {name: 'Músculo-esquelético y Reumatológico', items: [
      {id:'ar',          name:'Artritis Reumatoidea', codes:['M05.0','M05.1','M05.2','M05.3','M05.8','M05.9','M06.0','M06.1','M06.2','M06.3','M06.4','M06.8','M06.9']},
      {id:'artrosis',    name:'Artrosis de rodilla-cadera u otro tipo', codes:['M15.0','M15.1','M15.2','M15.3','M15.4','M15.8','M15.9','M16.0','M16.1','M16.2','M16.3','M16.4','M16.5','M16.6','M16.7','M16.9','M17.0','M17.1','M17.2','M17.3','M17.4','M17.5','M17.9','M18.0','M18.1','M18.2','M18.3','M18.4','M18.5','M18.9','M19.0','M19.1','M19.2','M19.9']},
      {id:'lupus',       name:'Lupus', codes:['L93.0','L93.1','L93.2','M32.0','M32.1','M32.8','M32.9']},
      {id:'dolor_neuro', name:'Dolor neuropático / fibromialgia', codes:['G50.0','G50.1','G50.8','G50.9','M79.7']},
      {id:'gota',        name:'Hiperuricemia / Gota', codes:['M10.0', 'M10.1', 'M10.2', 'M10.3', 'M10.4', 'M10.9']}
    ]},
    {name: 'Endocrino / Metabólico / Renal / Urológico', items: [
      {id:'obesidad',    name:'Obesidad', codes:['E66.0','E66.1','E66.2','E66.8','E66.9']},
      {id:'erc_i_iii',   name:'Enfermedad renal crónica', codes:['N15.0','N15.1','N15.8','N15.9','N18.1','N18.2','N18.3','N18.9','N19']},
      {id:'tiroides',    name:'Trastornos tiroideos', codes:['E01.0','E01.1','E01.2','E02','E03.0','E03.1','E03.2','E03.3','E03.4','E03.5','E03.8','E03.9','E05.0','E05.1','E05.2','E05.3','E05.4','E05.5','E05.8','E05.9']},
      {id:'hbp',         name:'Hipertrofia prostática benigna', codes:['N40']}
    ]},
    {name: 'Gastrointestinal / Hepático', items:[
      {id:'hepatico', name:'Enfermedad hepática', codes:['B18.0','B18.1','B18.2','B18.8','B18.9','K70.0','K70.1','K70.2','K70.3','K70.4','K70.9',...expMany([{base:'K71',subs:[0,1,2,3,4,5,6,7,8,9]}]),'K72.1','K73.0','K73.1','K73.2','K73.8','K73.9','K74.0','K74.1','K74.2','K74.3','K74.4','K74.5','K76.6']},
      {id:'eii',      name:'Enteritis crónica / colitis ulcerosa / Crohn', codes:['K50.0','K50.1','K50.8','K50.9','K51.0','K51.1','K51.2','K51.3','K51.8','K51.9','K52.0','K52.1','K52.2','K52.8','K52.9']}
    ]},
    {name: 'Sensorial (Oftalmo / Otorrino)', items: [
      {id:'catarata_ret',name:'Catarata / Retinopatía', codes:['H25.0','H25.1','H25.2','H25.8','H25.9','H26.0','H26.1','H26.2','H26.3','H26.4','H26.8','H26.9','H28.0','H28.1','H28.2','H28.8','Q12.0','Q12.1','Q12.2','Q12.3','Q12.4','Q12.8','Q12.9']},
      {id:'ceguera',     name:'Ceguera', codes:['H54.0','H54.1','H54.2','H54.3','H54.4','H54.5','H54.6','H54.7']},
      {id:'glaucoma',    name:'Glaucoma', codes:['H40.1','H40.2','H40.3','H40.4','H40.5','H40.6','H40.8','H40.9','H42.0','H42.8']},
      {id:'hipoacusia',  name:'Presbiacusia / Hipoacusia / Sordera', codes:['H90.0','H90.1','H90.2','H90.3','H90.4','H90.5','H90.6','H90.7','H90.8','H91.0','H91.1','H91.2','H91.3','H91.8','H91.9']}
    ]},
    {name: 'Social y Violencia', items:[
      {id:'psicosocial', name:'Dificultades socioeconómicas o psicosociales', codes:['Z55.0','Z55.8','Z55.9','Z56.0','Z56.1','Z56.6','Z56.7', ...expMany([{base:'Z57',subs:[0,1,2,3,4,5,6,7,8,9]}]),'Z58.0','Z58.1','Z58.2','Z58.3','Z58.4','Z58.5','Z58.8','Z59.0','Z59.1','Z59.4','Z59.5','Z59.6','Z59.7','Z59.8','Z59.9','Z60.5','Z60.8','Z60.9','Z62.5','Z62.8','Z62.9','Z63.8','Z63.9','Z65.8','Z65.9']},
      {id:'vif', name:'Maltrato físico / psicológico / VIF', codes:['T74.0','T74.1','T74.2','T74.3','T74.8','T74.9','Y07.0','Y07.1','Y07.2','Y07.3','Y07.8','Y07.9']}
    ]},
    {name:'Otras Condiciones Sistémicas / Infecciosas / Hematológicas', items:[
      {id:'anemia', name:'Anemia crónica', codes:['D50', ...expMany([{base:'D51',subs:[0,1,2,3,8,9]}]),...expMany([{base:'D52',subs:[0,1,8,9]}]),...expMany([{base:'D53',subs:[0,1,2,8,9]}]),...expMany([{base:'D55',subs:[0,1,2,3,8,9]}]),...expMany([{base:'D56',subs:[0,1,2,3,4,8,9]}]),...expMany([{base:'D57',subs:[0,1,2,3,8]}]),...expMany([{base:'D58',subs:[0,1,2,8,9]}]),...expMany([{base:'D59',subs:[0,1,2,3,4,5,6,8,9]}]),...expMany([{base:'D60',subs:[0,1,8,9]}]),...expMany([{base:'D61',subs:[0,1,2,3,8,9]}]),'D62',...expMany([{base:'D63',subs:[0,8]}]),...expMany([{base:'D64',subs:[0,1,2,3,4,8,9]}])]},
      {id:'vih', name:'Infección por VIH / SIDA', codes:['B21.0','B21.1','B21.2','B21.3','B21.7','B21.8','B21.9','B22.0','B22.1','B22.2','B22.7','B23.0','B23.1','B23.2','B23.8','B24']},
      {id:'tb',  name:'Tuberculosis', codes:[...expMany([{base:'A15',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expMany([{base:'A16',subs:[0,1,2,3,4,5,7,8,9]}]),...expMany([{base:'A17',subs:[0,1,8,9]}]),...expMany([{base:'A18',subs:[0,1,2,3,4,5,6,7,8]}]),...expMany([{base:'A19',subs:[0,1,2,8,9]}])]},
      {id:'cancer', name:'Malignidad / Neoplasia', codes:[{code:'C00–C97', label:'Todas las neoplasias malignas'},{code:'D00–D48', label:'Neoplasias in situ, benignas y de comp. incierto'}]},
      {id:'coagulacion',name:'Trastornos de la coagulación', codes:['D68.0','D68.1','D68.2','D68.4','D68.8','D68.9','D69.1','D69.2','D69.4','D69.6','D69.8','D69.9','D75.0','D75.8','D75.9','D77']}
    ]}
  ]}
];

/* ===== Render ===== */
function labelFor(code){
  if(!code || typeof code !== 'string') return '';
  if(CIE[code]) return CIE[code];
  const base = code.split('.')[0];
  if(CIE[base]) return CIE[base];
  const short = code.slice(0,3);
  return CIE[short] || '(rótulo tabular no disponible)';
}

function buildCieTable(codes){
  const wrap=el('div');
  const table=el('table',{class:'cie-table'});
  const thead=el('thead');
  thead.appendChild(el('tr',{},[el('th',{text:'Código'}),el('th',{text:'Diagnóstico'})]));
  table.appendChild(thead);
  const tbody=el('tbody');

  (codes||[]).forEach(entry=>{
    let code,label;
    if(typeof entry==='string'){
      code = entry;
      label = labelFor(code);
    }else if(entry && typeof entry==='object'){
      code = entry.code;
      label = entry.label || '(rango)';
    }
    const tr=el('tr');
    tr.appendChild(el('td',{text:code||''}));
    tr.appendChild(el('td',{text:label||''}));
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  wrap.appendChild(table);
  wrap.appendChild(el('div',{class:'cie-help',text:'Lista tabular CIE-10 aplicada (rótulos por código o por familia).'}));
  return wrap;
}

function buildUI(){
  const root = $('#list'); root.innerHTML='';
  GROUPS.forEach(g=>{
    const det=el('details');
    const sum=el('summary',{html:`${g.title} <span class="small">(+${g.points} pts c/u)</span>`});
    det.appendChild(sum);
    const wrap=el('div',{class:'level-wrap'});

    g.subgroups.forEach(sg=>{
      const sd=el('details',{class:'sub-details', open:true});
      const ss=el('summary',{class:'sub-summary',text:sg.name});
      sd.appendChild(ss);
      const sc=el('div',{class:'sub-content'});

      sg.items.forEach(it=>{
        const row=el('div',{class:'row'});
        const cb = el('input',{type:'checkbox',id:it.id}); cb.dataset.score=g.points; cb.addEventListener('change',calcScore);
        row.appendChild(cb);
        const lab=el('label',{htmlFor:it.id,text:it.name}); row.appendChild(lab);
        row.appendChild(el('span',{class:'badge',text:`+${g.points}`}));

        const cieDet=el('details',{class:'cie'}); const cieSum=el('summary',{text:'CIE-10'});
        const inner=el('div',{class:'inner'}); inner.appendChild(buildCieTable(it.codes||[]));
        cieDet.appendChild(cieSum); cieDet.appendChild(inner);

        row.dataset.itemId=it.id; row.dataset.name=it.name.toLowerCase();
        row.dataset.codes=(it.codes||[]).map(e=> typeof e==='string'? e : (e.code||'') ).join('|').toLowerCase();

        sc.appendChild(row); sc.appendChild(cieDet);
      });
      sd.appendChild(sc); wrap.appendChild(sd);
    });
    det.appendChild(wrap); root.appendChild(det);
  });
  runConsoleTests();
}

/* ===== Puntaje ===== */
function calcScore(){
  let total=0;
  $$('#list input[type=checkbox]').forEach(cb=>{ if(cb.checked) total += parseInt(cb.dataset.score,10); });
  const score=$('#score'), gl=$('#glevel'), gd=$('#gdesc');
  score.textContent=total;
  let lvl='G0', cls='g0', desc='<strong>Bajo Riesgo:</strong> Sin patologías con puntaje.';
  if(total>=5){ lvl='G3'; cls='g3'; desc='<strong>Alto Riesgo:</strong> Manejo multidisciplinario y coordinación estrecha.'; }
  else if(total>=2){ lvl='G2'; cls='g2'; desc='<strong>Riesgo Moderado:</strong> APS integral y eventual coordinación con especialidades.'; }
  else if(total===1){ lvl='G1'; cls='g1'; desc='<strong>Riesgo Bajo a Moderado:</strong> Una condición con puntaje; control según patología.'; }
  gl.textContent=lvl; gd.innerHTML=desc;
  ['g0','g1','g2','g3'].forEach(c=>{gl.classList.remove(c);gd.classList.remove(c);});
  gl.classList.add(cls); gd.classList.add(cls);
}
function resetForm(){
  $$('#list input[type=checkbox]').forEach(cb=>cb.checked=false);
  calcScore(); clearSearch();
}

/* ===== Buscador + AUTOCOMPLETE ===== */
(function(){
  const input=document.getElementById('q');
  const clearBtn=document.getElementById('clearQ');
  const acBox=document.getElementById('suggestions');

  function hideSuggestions(){
    acBox.hidden = true; acBox.innerHTML=''; acState.open = false; acState.items=[]; acState.activeIndex=-1;
  }
  function clearSearch(){
    if(!input) return;
    input.value='';
    $$('.row').forEach(r=>r.classList.remove('match'));
    hideSuggestions();
  }
  window.clearSearch=clearSearch;

  // === AUTOCOMPLETE: índice desde CIE (se omiten rangos tipo C00–C97)
  const INDEX = Object.entries(CIE)
    .filter(([code, desc]) => code && desc && !code.includes('–'))
    .map(([code, desc]) => ({ code, desc, ncode: normalize(code), ndesc: normalize(desc) }));

  function escapeReg(str){ return str.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  function rank(entry, term){
    let s = 0;
    if(entry.ncode.startsWith(term)) s += 50;
    else if(entry.ncode.includes(term)) s += 30;
    const rx = new RegExp(`\\b${escapeReg(term)}`);
    if(rx.test(entry.ndesc)) s += 25;
    else if(entry.ndesc.includes(term)) s += 10;
    s -= Math.max(0, entry.code.length - 3) * 0.2;
    return s;
  }

  let acState = { open:false, items:[], activeIndex:-1 };

  function buildSuggestions(){
    const raw = input.value.trim();
    const term = normalize(raw);
    if(term.length < 2){ hideSuggestions(); return; }

    const items = INDEX
      .map(e => ({...e, score: rank(e, term)}))
      .filter(e => e.score > 0)
      .sort((a,b)=> b.score - a.score || a.code.localeCompare(b.code))
      .slice(0, 8);

    acState.items = items;
    acState.activeIndex = items.length ? 0 : -1;
    renderSuggestions();
  }

  function renderSuggestions(){
    acBox.innerHTML = '';
    if(acState.items.length === 0){
      acBox.appendChild(el('div',{class:'ac-empty',text:'❌ No se encontraron resultados'}));
      acBox.hidden = false; acState.open = true; return;
    }
    acState.items.forEach((it, i) => {
      const item = el('div',{class:`ac-item ${i===acState.activeIndex?'active':''}`, role:'option', tabindex:'-1'});
      item.appendChild(el('span',{class:'ac-code', text:it.code}));
      item.appendChild(el('span',{class:'ac-desc', text:it.desc}));
      item.addEventListener('mousedown', (ev)=>{ ev.preventDefault(); applySuggestion(it); });
      acBox.appendChild(item);
    });
    acBox.hidden = false; acState.open = true;
  }

  function moveActive(delta){
    if(!acState.open || acState.items.length===0) return;
    acState.activeIndex = (acState.activeIndex + delta + acState.items.length) % acState.items.length;
    renderSuggestions();
  }

  function doSearch(needle){
    const term = normalize(needle != null ? needle : input.value.trim());
    $$('.row').forEach(r=>r.classList.remove('match'));
    if(term.length<2) return;
    $$('.row').forEach(row=>{
      const n=normalize(row.dataset.name); const c=(row.dataset.codes||'');
      if(n.includes(term)||c.includes(term)){
        row.classList.add('match');
        const sub=row.closest('.sub-details'); if(sub) sub.open=true;
        const top=row.closest('details'); if(top) top.open=true;
      }
    });
  }

  // === Marca la condición y suma el puntaje por código exacto
  function selectByCode(code){
    const lc = (code||'').toLowerCase();
    let targetRow = null;
    for (const row of $$('.row')) {
      const codes = (row.dataset.codes||'').split('|');
      if (codes.includes(lc)) { targetRow = row; break; }
    }
    if (targetRow) {
      const cb = targetRow.querySelector('input[type=checkbox]');
      if (cb && !cb.checked) cb.checked = true; // marca
      calcScore();                                // suma
      const sub = targetRow.closest('.sub-details'); if (sub) sub.open = true;
      const top = targetRow.closest('details');      if (top) top.open = true;
      targetRow.classList.add('match');
      targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function applySuggestion(entry){
    input.value = `${entry.code} — ${entry.desc}`;
    hideSuggestions();
    doSearch(entry.code);     // resalta y abre
    selectByCode(entry.code); // ✅ marca y suma
  }

  if(input){
    input.addEventListener('input',()=>{
      window.clearTimeout(input._t);
      input._t=setTimeout(()=>{ buildSuggestions(); doSearch(); }, 120);
    });
    input.addEventListener('keydown',(e)=>{
      if(!acState.open) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); moveActive(1); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); moveActive(-1); }
      else if(e.key==='Enter'){
        if(acState.items.length){
          e.preventDefault();
          applySuggestion(acState.items[Math.max(0, acState.activeIndex)]);
        }
      }else if(e.key==='Escape'){ hideSuggestions(); }
    });
  }
  if(clearBtn){ clearBtn.addEventListener('click',clearSearch); }

  document.addEventListener('click', (e)=>{
    if(!e.target.closest('.search')) hideSuggestions();
  });
})();

/* ===== Validaciones en consola ===== */
function tAssert(name, fn){
  try{ const ok=!!fn(); console[ok?'log':'error'](`${ok?'[OK]':'[FALLA]'} ${name}`); return ok; }
  catch(e){ console.error(`[ERROR] ${name}:`,e); return false; }
}
function runConsoleTests(){
  console.log('--- Ejecutando validaciones ---');
  const totalItems = GROUPS.reduce((a,g)=>a+g.subgroups.reduce((b,sg)=>b+sg.items.length,0),0);
  tAssert(`Total de condiciones = 52`,()=> totalItems === 52 );
  console.log('--- Validaciones completadas ---');
}

document.addEventListener('DOMContentLoaded', ()=>{ buildUI(); calcScore(); });
</script>
</body>
</html>

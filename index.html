<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estratificador de Pacientes ECICEP</title>
  <meta name="description" content="Sistema de estratificación ECICEP (Anexo oficial: 52 condiciones) – CESFAM Dr. Carlos Díaz Gidi 2025"/>
  <style>
    :root{
      --primary:#0b5ed7; --secondary:#f6f7fb; --border:#e5e7eb; --text:#1f2937; --bg:#fff;
      --g0:#28a745; --g1:#17a2b8; --g2:#ffc107; --g3:#dc3545; --shadow:0 6px 16px rgba(0,0,0,.08);
      --hl:#fff3cd; --hl-border:#ffe69c;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--secondary);color:var(--text);margin:0;padding:24px}
    .container{max-width:1200px;margin:0 auto;background:var(--bg);border-radius:14px;box-shadow:var(--shadow);padding:24px;border:1px solid var(--border)}
    header h1{margin:0 0 6px;color:var(--primary);text-align:center}
    header p{margin:0 0 14px;text-align:center;color:#374151}
    .main{display:grid;grid-template-columns:1fr 340px;gap:24px}
    @media (max-width:980px){.main{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}

    details{border:1px solid var(--border);border-radius:10px;background:#fafafa;margin-top:12px}
    summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:700;color:#fff;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:space-between}
    details[open] summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
    .level-wrap{padding:10px 12px;background:#fff;border-top:1px solid var(--border);border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    .sub-details{border:1px solid #dbeafe;border-radius:8px;background:#eef2ff;margin:10px 0}
    .sub-summary{background:#eef2ff;color:#1e40af;border-radius:8px;padding:8px 12px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
    .sub-content{padding:8px 10px;background:#fff;border-top:1px solid #dbeafe}

    .row{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;padding:8px 0;border-bottom:1px dashed #eceff3}
    .row:last-child{border-bottom:none}
    .row input[type=checkbox]{width:18px;height:18px}
    .row label{font-weight:600}
    .row.match{background:var(--hl);border:1px solid var(--hl-border);border-radius:8px;padding:8px;margin:4px 0}
    .badge{font-size:.75rem;font-weight:700;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff}

    .topbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin:6px 0 14px}
    .search{flex:1;display:flex;gap:8px}
    .search input{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:10px;font-size:1rem}
    .search button{padding:12px 14px;border:1px solid var(--border);border-radius:10px;background:#f3f4f6;cursor:pointer}

    .cie{margin:8px 0 16px 26px;border:1px dashed #e5e7eb;border-radius:8px;background:#f9fafb}
    .cie summary{background:#f3f4f6;color:#111827;border-radius:8px;padding:6px 10px}
    .cie .inner{padding:10px}
    .cie-table{width:100%;border-collapse:collapse;font-size:.92rem}
    .cie-table th,.cie-table td{border:1px solid #e5e7eb;padding:6px 8px;text-align:left}
    .cie-table th{background:#eef2ff;color:#1e3a8a}
    .cie-help{font-size:.82rem;color:#6b7280;margin-top:4px}

    .results h3{margin:0 0 10px;color:var(--primary);text-align:center;border-bottom:2px solid var(--border);padding-bottom:10px}
    #score{font-size:3.2em;text-align:center;font-weight:900;margin:10px 0;color:#111827}
    #glevel{text-align:center;font-weight:900;font-size:2em;margin-bottom:10px;color:#fff;border-radius:8px;padding:6px}
    #gdesc{font-size:.95em;padding:10px;background:#f8fafc;border-radius:8px;border-left:6px solid}
    .g0{background-color:var(--g0);border-color:var(--g0)} .g1{background-color:var(--g1);border-color:var(--g1)}
    .g2{background-color:var(--g2);border-color:var(--g2);color:#111827} .g3{background-color:var(--g3);border-color:var(--g3)}
    .btn{width:100%;padding:12px;font-size:1.05em;font-weight:800;border:none;border-radius:10px;cursor:pointer;background:#374151;color:#fff;margin-top:10px}
    footer{margin-top:18px;font-size:.9rem;color:#4b5563;text-align:center}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Estratificador de Pacientes ECICEP</h1>
    <p>Basado en el Anexo oficial ECICEP. CESFAM Dr. Carlos Díaz Gidi — 2025.</p>
    <details class="card" open>
      <summary class="sub-summary">Cómo usarlo</summary>
      <div class="sub-content">
        <ol>
          <li>Abra los bloques de <strong>2 puntos</strong> y <strong>1 punto</strong> y marque las condiciones que correspondan.</li>
          <li>Use el buscador para <strong>desplegar y resaltar</strong> patologías por nombre o código CIE‑10 (opcional).</li>
          <li>En cada ítem puede ver el detalle de <strong>CIE‑10</strong> (código + diagnóstico) desplegando la sección.</li>
          <li>La tarjeta derecha muestra el <strong>puntaje total</strong> y el <strong>nivel G0–G3</strong> automáticamente.</li>
          <li>Use <strong>“Limpiar selección”</strong> para reiniciar todo.</li>
        </ol>
      </div>
    </details>
  </header>

  <div class="main">
    <div>
      <div class="card">
        <div class="topbar">
          <div class="search" style="width:100%">
            <input id="q" type="search" placeholder="Buscar patología o código CIE‑10…" aria-label="Buscar patología" />
            <button id="clearQ" title="Limpiar búsqueda">Limpiar</button>
          </div>
        </div>
        <h2 style="margin:6px 0 12px">Condiciones crónicas</h2>
        <div id="list"></div>
      </div>
    </div>

    <aside>
      <div class="card results">
        <h3>Resultado de Estratificación</h3>
        <div id="score">0</div>
        <div id="glevel" class="g0">G0</div>
        <p id="gdesc" class="g0"><strong>Bajo Riesgo:</strong> Sin patologías con puntaje.</p>
        <button class="btn" onclick="resetForm()">Limpiar selección</button>
      </div>
      <footer>
        Creado por <strong>Diego Ortega Araya</strong> – <strong>14 de agosto de 2025</strong>.
      </footer>
    </aside>
  </div>
</div>

<script>
/* ==========================
   Helpers
   ========================== */
function expand(base, digits){ return (digits||[]).map(d=>`${base}.${d}`); }
function expandMany(specs){ const out=[]; (specs||[]).forEach(s=>{ if(typeof s==="string") out.push(s); else if(s && s.base && Array.isArray(s.subs)) out.push(...expand(s.base,s.subs)); }); return out; }
function normalize(s){
  // Compatible ampliamente (sin Unicode property escapes)
  return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}

/* ==========================
   Diccionario CIE-10 (resumen)
   ========================== */
const CIE={
  "F10":"Trastornos debidos al alcohol","Y91":"Efectos del alcohol","Z71.4":"Consejería por alcohol","Z72.1":"Uso de alcohol",
  "F17":"Trastornos por tabaco","T65.2":"Efecto tóxico de nicotina","Z71.6":"Consejería por tabaco","Z72.0":"Uso de tabaco",
  "F11":"Trastornos por opiáceos","F12":"Trastornos por cannabinoides","F13":"Trastornos por sedantes/hipnóticos","F14":"Trastornos por cocaína","F15":"Trastornos por estimulantes","F16":"Trastornos por alucinógenos","F18":"Trastornos por disolventes","F19":"Múltiples drogas","Z72.2":"Uso de drogas",
  "D50":"Anemia por deficiencia de hierro","D51":"Anemia por deficiencia de B12","D52":"Anemia por deficiencia de folato","D53":"Otras anemias nutricionales","D55":"Anemias por enzimas","D56":"Talasemias","D57":"Anemia falciforme","D58":"Otras anemias hemolíticas hereditarias","D59":"Anemia hemolítica adquirida","D60":"Aplasia pura de serie roja","D61":"Otras anemias aplásicas","D62":"Anemia posthemorrágica aguda","D63":"Anemia en enfermedades crónicas","D64":"Otras anemias",
  "M05":"AR seropositiva","M06":"Otras artritis reumatoides","M15":"Poliartrosis","M16":"Coxartrosis","M17":"Gonartrosis","M18":"Rizartrosis","M19":"Otras artrosis",
  "J45":"Asma","J46":"Estado asmático",
  "H25":"Catarata senil","H26":"Otras cataratas","H28":"Alteraciones del cristalino en otras enfermedades","Q12":"Catarata congénita",
  "H54":"Ceguera y baja visión",
  "H40":"Glaucoma","H42":"Glaucoma en otras enfermedades",
  "F00":"Demencia en Alzheimer","F01":"Demencia vascular","F02":"Demencia en otras enfermedades","F03":"Demencia NE",
  "F33.0":"Depresión recidivante leve","F33.1":"Depresión recidivante moderada","F33.2":"Depresión recidivante grave sin psicosis","F33.3":"Depresión recidivante grave con psicosis","F33.4":"Remisión","F33.8":"Otros","F33.9":"NE",
  "F20":"Esquizofrenia","F21":"Esquizotípico","F22":"Delirantes persistentes","F23":"Psicosis aguda y transitoria",
  "E10":"Diabetes tipo 1","E11":"Diabetes tipo 2","E12":"Diabetes por desnutrición","E13":"Otras DM","E14":"DM NE",
  "Z55":"Problemas de educación","Z56":"Problemas de empleo","Z57":"Exposición ocupacional","Z58":"Exposición ambiental","Z59":"Problemas de vivienda/economía","Z60":"Problemas del entorno social","Z62":"Crianza","Z63":"Apoyo familiar","Z65":"Otros problemas psicosociales",
  "E78":"Dislipidemias","E66":"Obesidad",
  "G46":"Síndromes vasculares encefálicos","I64":"ACV NE","I67":"Otros trastornos cerebrovasculares","I68":"Cerebrovasculares en otras enfermedades","G45":"TIA",
  "B18":"Hepatitis viral crónica","K70":"Hígado alcohólico","K71":"Hígado tóxico","K72.1":"Insuficiencia hepática crónica","K73":"Hepatitis crónica","K74":"Fibrosis/Cirrosis","K76.6":"Hipertensión portal",
  "J41":"Bronquitis crónica simple/mucopurulenta","J42":"Bronquitis crónica NE","J43":"Enfisema","J44":"EPOC",
  "N15":"Nefropatías túbulo‑intersticiales","N18":"Enfermedad renal crónica","N19":"Insuficiencia renal NE",
  "I20":"Angina","I21":"IAM","I22":"IAM subsecuente","I25":"Cardiopatía isquémica crónica","I51":"Otros trastornos del corazón","I52":"Trastornos cardiacos en otras enfermedades",
  "K50":"Crohn","K51":"Colitis ulcerosa","K52":"Otras colitis no infecciosas",
  "G40":"Epilepsia","G35":"Esclerosis múltiple","G20":"Parkinson","G21":"Parkinsonismo secundario","G22":"Parkinsonismo en otras enfermedades","G23":"Otras enf. ganglios basales","G24":"Distonías","G25":"Otros extrapiramidales","G26":"Extrapiramidales en otras enfermedades","G50":"Trastornos del trigémino",
  "I47":"Taquicardia paroxística","I49":"Otras arritmias","I48":"Fibrilación/Flutter","I50":"Insuficiencia cardiaca",
  "M10":"Gota/Hiperuricemia","N40":"Hiperplasia prostática benigna",
  "E01":"Trastornos tiroideos por deficiencia de yodo","E02":"Hipotiroidismo subclínico por deficiencia de yodo","E03":"Otros hipotiroidismos","E05":"Tirotoxicosis",
  "B21":"VIH con neoplasias","B22":"VIH con otras enfermedades esp.","B23":"Otras afecciones por VIH","B24":"VIH NE",
  "A15":"TB respiratoria","A17":"TB del sistema nervioso","A18":"TB de otros órganos","A19":"TB miliar",
  "L93":"Lupus cutáneo","M32":"Lupus sistémico",
  "C00":"Neoplasias malignas (C00–C97)","D00":"Tumores in situ/benignos/inciertos (D00–D48)",
  "T74":"Maltrato","Y07":"Agresor",
  "H90":"Hipoacusia","H91":"Otros trastornos de audición",
  "D68":"Trastornos de la coagulación","D69":"Púrpuras y otras afecciones hemorrágicas","D75":"Otras enfermedades de la sangre","D77":"Otros trastornos de la sangre en otras enfermedades",
  "L97":"Úlcera de extremidad inferior","L98.4":"Úlcera crónica de la piel NE",
  "F40":"Ansiedad fóbica","F41":"Otros trastornos de ansiedad","F42":"TOC",
  "F60":"Trastornos específicos de la personalidad","F61":"Trastornos mixtos","F62":"Cambios perdurables de la personalidad","F68":"Otros trastornos de la personalidad","F69":"Personalidad NE",
  "F51":"Trastornos del sueño no orgánicos","G47":"Trastornos del sueño orgánicos",
  "F31":"Trastorno afectivo bipolar","F34":"Trastornos del humor persistentes","F63":"Trastornos de los hábitos e impulsos","F66":"Trastornos del desarrollo/identidad sexual"
};

/* ==========================
   Estructura – 52 condiciones
   ========================== */
const GROUPS=[
  {points:2,title:'Condiciones que suman 2 puntos',subgroups:[
    {name:'Neuro-psiquiatría',items:[
      {id:'demencia',name:'Demencia',codes:['F00','F01','F02','F03']},
      {id:'dep_grave',name:'Depresión Grave (recurrente, con/sin psicosis)',codes:['F33.2','F33.3']},
      {id:'esquizo',name:'Espectro esquizofrenia y psicosis',codes:['F20','F21','F22','F23']}
    ]},
    {name:'Cardiovascular y renal',items:[
      {id:'ecv',name:'Enfermedad cerebrovascular / ACV / AVE',codes:['G46','I64','I67','I68']},
      {id:'dm',name:'Diabetes mellitus (E10–E14)',codes:[...expandMany([{base:'E10',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expandMany([{base:'E11',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expandMany([{base:'E12',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expandMany([{base:'E13',subs:[0,1,2,3,4,5,6,7,8,9]}]),...expandMany([{base:'E14',subs:[0,1,2,3,4,5,6,7,8,9]}])]},
      {id:'erc_av',name:'ERC avanzada (IV–V/terminal)',codes:['N18.4','N18.5','N18.6']},
      {id:'isci',name:'IAM / Angina / Cardiopatía isquémica',codes:['I20','I21','I22','I25','I51','I52']}
    ]},
    {name:'Funcionalidad',items:[
      {id:'dependencia',name:'Función limitada / discapacidad / dependencia',codes:['R26','Z74','Z99']}
    ]}
  ]},
  {points:1,title:'Condiciones que suman 1 punto',subgroups:[
    {name:'Salud mental y conductual',items:[
      {id:'alcohol',name:'Consumo perjudicial/dependiente de alcohol',codes:['F10','Y91','Z71.4','Z72.1']},
      {id:'tabaquismo',name:'Tabaquismo',codes:['F17','T65.2','Z71.6','Z72.0']},
      {id:'drogas',name:'Consumo perjudicial o dependiente de drogas',codes:['F11','F12','F13','F14','F15','F16','F18','F19','Z72.2']},
      {id:'dep_leve',name:'Depresión leve o moderada (recurrente)',codes:['F33.0','F33.1','F33.4','F33.8','F33.9']},
      {id:'ansiedad',name:'Trastorno ansioso / TOC',codes:['F40','F41','F42']},
      {id:'personalidad',name:'Trastorno de la personalidad',codes:['F60','F61','F62','F68','F69']},
      {id:'sueno',name:'Trastornos del sueño',codes:['F51','G47']},
      {id:'otros_sm',name:'Otros trastornos de salud mental',codes:['F31','F34','F63','F66']},
      {id:'psicosocial',name:'Dificultades socioeconómicas o psicosociales',codes:['Z55','Z56','Z57','Z58','Z59','Z60','Z62','Z63','Z65']},
      {id:'vif',name:'Maltrato/VIF/abuso sexual/ideación o intento suicida',codes:['T74','Y07']}
    ]},
    {name:'Cardiometabólico y renal',items:[
      {id:'dislipidemia',name:'Dislipidemias',codes:['E78']},
      {id:'hta',name:'Hipertensión',codes:['I10','I11','I12','I13','I15']},
      {id:'fa',name:'Fibrilación auricular / flutter',codes:['I48']},
      {id:'arritmias',name:'Arritmia cardíaca / taquicardia paroxística',codes:['I47','I49']},
      {id:'insuf_card',name:'Insuficiencia cardiaca',codes:['I50']},
      {id:'erc_i_iii',name:'ERC (I–III / NE)',codes:['N15','N18.1','N18.2','N18.3','N18.9','N19']},
      {id:'obesidad',name:'Obesidad',codes:['E66']},
      {id:'hbp',name:'Hiperplasia prostática benigna',codes:['N40']},
      {id:'gota',name:'Hiperuricemia / Gota',codes:['M10']}
    ]},
    {name:'Respiratorio',items:[
      {id:'asma',name:'Asma',codes:['J45','J46']},
      {id:'epoc',name:'EPOC',codes:['J41','J42','J43','J44']},
      {id:'tuberculosis',name:'Tuberculosis',codes:['A15','A17','A18','A19']}
    ]},
    {name:'Neurológico',items:[
      {id:'epilepsia',name:'Epilepsia',codes:['G40']},
      {id:'em',name:'Esclerosis múltiple',codes:['G35']},
      {id:'parkinson',name:'Parkinsonismo y extrapiramidales',codes:['G20','G21','G22','G23','G24','G25','G26']},
      {id:'dolor_neuro',name:'Dolor neuropático / fibromialgia',codes:['G50','M79.7']}
    ]},
    {name:'Músculo-esquelético y reuma',items:[
      {id:'ar',name:'Artritis reumatoide',codes:['M05','M06']},
      {id:'artrosis',name:'Artrosis (rodilla, cadera u otras)',codes:['M15','M16','M17','M18','M19']}
    ]},
    {name:'Sistémicas, infecciosas y varias',items:[
      {id:'anemia',name:'Anemia crónica',codes:['D50','D51','D52','D53','D55','D56','D57','D58','D59','D60','D61','D62','D63','D64']},
      {id:'hepatico',name:'Enfermedad hepática crónica',codes:['B18','K70','K71','K72.1','K73','K74','K76.6']},
      {id:'eii',name:'Enteritis crónica / CU / Crohn',codes:['K50','K51','K52']},
      {id:'vih',name:'Infección por VIH / SIDA',codes:['B21','B22','B23','B24']},
      {id:'lupus',name:'Lupus',codes:['L93','M32']},
      {id:'cancer',name:'Malignidad / Neoplasia / Cáncer (C00–C97 y D00–D48)',codes:['C00','D00']},
      {id:'hipoacusia',name:'Presbiacusia / Hipoacusia / Sordera',codes:['H90','H91']},
      {id:'coagulacion',name:'Trastornos de la coagulación',codes:['D68','D69','D75','D77']},
      {id:'retraso_mental',name:'Retraso mental (discapacidad intelectual)',codes:['F70','F71','F72','F73','F78','F79']},
      {id:'tiroides',name:'Trastornos tiroideos',codes:['E01','E02','E03','E05']},
      {id:'ulcera',name:'Úlcera crónica de la piel',codes:['I83','L97','L98.4']},
      {id:'catarata_retino',name:'Catarata / Retinopatía',codes:['H25','H26','H28','Q12']},
      {id:'ceguera',name:'Ceguera',codes:['H54']},
      {id:'glaucoma',name:'Glaucoma',codes:['H40','H42']}
    ]}
  ]}
];

/* ==========================
   Render UI
   ========================== */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
function el(tag,props={},children=[]){ const n=document.createElement(tag); Object.entries(props).forEach(([k,v])=>{ if(k==='class') n.className=v; else if(k==='text') n.textContent=v; else if(k==='html') n.innerHTML=v; else n[k]=v; }); children.forEach(c=>n.appendChild(c)); return n; }
function buildCieTable(codes){ const wrap=el('div'); const table=el('table',{class:'cie-table'}); const thead=el('thead'); thead.appendChild(el('tr',{},[el('th',{text:'Código'}),el('th',{text:'Diagnóstico'})])); table.appendChild(thead); const tbody=el('tbody'); (codes||[]).forEach(code=>{ const label=CIE[code] || CIE[code.replace(/\.[0-9]$/,'')] || '(descripción no disponible)'; const tr=el('tr'); tr.appendChild(el('td',{text:code})); tr.appendChild(el('td',{text:label})); tbody.appendChild(tr); }); table.appendChild(tbody); wrap.appendChild(table); wrap.appendChild(el('div',{class:'cie-help',text:'Listado según CIE‑10 2017 (MINSAL).'})); return wrap; }
function buildUI(){ const root=$('#list'); root.innerHTML=''; GROUPS.forEach(g=>{ const det=el('details'); const sum=el('summary',{html:`${g.title} <span class="small">(+${g.points} pts c/u)</span>`}); det.appendChild(sum); const wrap=el('div',{class:'level-wrap'}); g.subgroups.forEach(sg=>{ const sd=el('details',{class:'sub-details'}); const ss=el('summary',{class:'sub-summary',text:sg.name}); sd.appendChild(ss); const sc=el('div',{class:'sub-content'}); sg.items.forEach(it=>{ const row=el('div',{class:'row'}); const cb=el('input',{type:'checkbox',id:it.id}); cb.dataset.score=g.points; cb.addEventListener('change',calcScore); const lab=el('label',{htmlFor:it.id,text:it.name}); row.appendChild(cb); row.appendChild(lab); row.appendChild(el('span',{class:'badge',text:`+${g.points}`})); const cieDet=el('details',{class:'cie'}); const cieSum=el('summary',{text:'CIE‑10'}); const inner=el('div',{class:'inner'}); inner.appendChild(buildCieTable(it.codes||[])); cieDet.appendChild(cieSum); cieDet.appendChild(inner); row.dataset.itemId=it.id; row.dataset.name=it.name.toLowerCase(); row.dataset.codes=(it.codes||[]).join('|').toLowerCase(); sc.appendChild(row); sc.appendChild(cieDet); }); sd.appendChild(sc); wrap.appendChild(sd); }); det.appendChild(wrap); root.appendChild(det); }); runConsoleTests(); }

/* ==========================
   Puntaje y nivel G
   ========================== */
function calcScore(){ let total=0; $$('#list input[type=checkbox]').forEach(cb=>{ if(cb.checked) total+=parseInt(cb.dataset.score,10); }); const score=$('#score'), gl=$('#glevel'), gd=$('#gdesc'); score.textContent=total; let lvl='G0', cls='g0', desc='<strong>Bajo Riesgo:</strong> Sin patologías con puntaje.'; if(total>=5){ lvl='G3'; cls='g3'; desc='<strong>Alto Riesgo:</strong> Manejo multidisciplinario y coordinación estrecha.'; } else if(total>=2){ lvl='G2'; cls='g2'; desc='<strong>Riesgo Moderado:</strong> APS integral y eventual coordinación con especialidades.'; } else if(total===1){ lvl='G1'; cls='g1'; desc='<strong>Riesgo Bajo a Moderado:</strong> Una condición con puntaje; control según patología.'; } gl.textContent=lvl; gd.innerHTML=desc; ['g0','g1','g2','g3'].forEach(c=>{gl.classList.remove(c);gd.classList.remove(c);}); gl.classList.add(cls); gd.classList.add(cls); }
function resetForm(){ $$('#list input[type=checkbox]').forEach(cb=>cb.checked=false); calcScore(); clearSearch(); }

/* ==========================
   Buscador (complemento opcional)
   ========================== */
const q=document.addEventListener('DOMContentLoaded',()=>{ const input=$('#q'); const clearBtn=$('#clearQ'); function clearSearch(){ input.value=''; $$('.row').forEach(r=>r.classList.remove('match')); } window.clearSearch=clearSearch; function doSearch(){ const term=normalize(input.value.trim()); $$('.row').forEach(r=>r.classList.remove('match')); if(term.length<2) return; $$('.row').forEach(row=>{ const n=normalize(row.dataset.name); const c=row.dataset.codes||''; if(n.includes(term)||c.includes(term)){ row.classList.add('match'); const sub=row.closest('.sub-details'); if(sub) sub.open=true; const top=row.closest('details'); if(top) top.open=true; const cie=row.nextElementSibling; if(cie && cie.tagName.toLowerCase()==='details') cie.open=true; } }); } input.addEventListener('input',()=>{ window.clearTimeout(input._t); input._t=setTimeout(doSearch,150); }); clearBtn.addEventListener('click',()=>{ clearSearch(); }); });

/* ==========================
   Pruebas (consola)
   ========================== */
function tAssert(name,fn){ try{ const ok=!!fn(); console[ok?'log':'error'](`${ok?'[OK]':'[FALLA]'} ${name}`); return ok; }catch(e){ console.error(`[ERROR] ${name}:`,e); return false; }}
function runConsoleTests(){ tAssert('Total de condiciones = 52',()=> GROUPS.reduce((a,g)=>a+g.subgroups.reduce((b,sg)=>b+sg.items.length,0),0)===52 ); tAssert('FA separada de otras arritmias',()=> GROUPS.some(g=>g.subgroups.some(sg=>sg.items.some(i=>i.id==='fa'))) && GROUPS.some(g=>g.subgroups.some(sg=>sg.items.some(i=>i.id==='arritmias'))) ); tAssert('DM incluye E10–E14 (0–9)',()=> GROUPS.some(g=>g.points===2 && g.subgroups.some(sg=>sg.items.some(i=> i.id==='dm' && i.codes.includes('E10.0') && i.codes.includes('E14.9')))) ); }

// INIT
 document.addEventListener('DOMContentLoaded',()=>{ buildUI(); calcScore(); });
</script>
</body>
</html>

